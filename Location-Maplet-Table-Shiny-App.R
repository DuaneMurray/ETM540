#
####################################################################
# ETM-540 TEAM 1 FINAL PROJECT - SHINY APPLICATION
####################################################################
# 

library(shiny)
library(leaflet)
#library(DT)

setwd("G:/My Drive/FALL-2021/ETM640/Project/Code/") # SET WORKING DIR

tourist_locations <- read.csv("portland_location_data.csv") # LOAD DATA FROM FILE

# USE MEANINGFUL NAMES FOR THE DATA COLUMNS
colnames(tourist_locations) <- c("Attraction", 
                                 "InPDX", 
                                 "Cost",
                                 "Address",
                                 "DistanceFromDT",
                                 "OpenTime",
                                 "CloseTime",
                                 "latitude",
                                 "longitude",
                                 "Classification")

# JUST A TEMP LOCATION IN CASE WE NEED TO CHANGE THE SOURCE DATA MATRIX
refined_locations <- tourist_locations

# USER INTERFACE SECTION DEFINITION
ui <- fluidPage(
  
  # APPLICATION TITLE
  titlePanel("Attractions in Portland Oregon"),
  
  # CREATE A SIDEBAR SECTION
  sidebarLayout(  
    
    # CREATE PANEL - CAN BE SEVERAL DIFFERENT TYPES
    sidebarPanel(
      
      # USER BUDGET
      sliderInput(inputId = "budget" ,
                  label="What is your budget?:",
                  value = 40, min=0, max=200),
    
      # USER CATEGORY INTERESTS - CAN SELECT MULTIPLE OPTIONS
      selectInput("interests", "Choose the areas that you are interested in:",
                  list(`Interests` = list(
                    "Art",
                    "History",
                    "Adventure",
                    "Scenic",
                    "Sports",
                    "Foodie",
                    "Music",
                    "Shopping",
                    "Festivals",
                    "Eco Tourism",
                    "Architecture",
                    "Theatre",
                    "Landmark",
                    "Recreational")), multiple = TRUE),
      
      # DYNAMIC LIST FROM DATA FILE SHOWING ALL AVAILABLE ATTRACTIONS
      selectInput("locations", "Choose Specific Locations:", 
                  refined_locations[,1], selected = NULL, multiple = TRUE,
                  selectize = TRUE, width = NULL, size = NULL),
      
      # USER START TIME AVAILABLE - 24 HOUR CLOCK
      numericInput("start_time", "Start Time (24 Hour)", 1200),
      
      # USER END TIME AVAILABLE - 24 HOUR CLOCK
      numericInput("end_time", "End Time (24 Hour)", 2100),
      
      # EXAMPLE SELECTION TYPES
      #numericInput("min", "Minimum", 0),
      #numericInput("max", "Maximum", 100),
      #sliderInput("n", "n", min = 0, max = 100, value = 50),
      
      #plotOutput("optimal_path") # TEMP AREA FOR OPTIMIZATION OUTPUT
      
      actionButton("reset_input", "Reset"),
      actionButton("run_model", "RUN MODEL")
    ),
    
    # CREATE MAIN DATA OUTPUT AREA
    # NEED FUNCTION TO UPDATE DATA ON SELECTIONS IN SIDEBARPANEL()
    mainPanel (
      leafletOutput("mymap", height=600), # MAP OF TOURIST ATTRACTION LOCATIONS
      p(),
      dataTableOutput("data"), # LIST OF DATA FROM IMPORT FILE
      p() # BE SURE TO ADD A COMMA (,) TO THE END OF THIS IF PLOT ENABLED
      #plotOutput("optimal_path") # TEMP AREA FOR OPTIMIZATION OUTPUT
      
    )
    
  ) # END sidebarLayout()
  
) # END UI


# MAIN CODE TO GENERATE DATA TO SEND TO THE USER INTERFACE SECTION
server <- function(input, output, session) {
  
  # DEFINE AND RUN THE OPTIMIZATION MODEL HERE <- <- <- <-
  #
  # NEED TO HAVE THE AVERAGE TIME SPENT AT EACH LOCATION
  #
  #
  # SET REFINED LOCATION MATRIX VALUES AFTER PROCESSED

  # ASSOCIATED WITH THE MIN SLIDER VALUE IN THE USER INTERFACE
  observeEvent(input$min, {
    updateSliderInput(inputId = "n", min = input$min)
  })
  
  # ASSOCIATED WITH THE MAX SLIDER VALUE IN THE USER INTERFACE
  observeEvent(input$max, {
    updateSliderInput(inputId = "n", max = input$max)
  })
  
  # ASSOCIATED WITH THE BUDGET SLIDER VALUE IN THE USER INTERFACE
  observeEvent(input$budget, {
    #
  })
  
  # ASSOCIATED WITH THE INTEREST SELECTION VALUES IN THE USER INTERFACE
  observeEvent(input$interests, {
    #
  })
  
  # ASSOCIATED WITH THE INTEREST SELECTION VALUES IN THE USER INTERFACE
  observeEvent(input$locations, {
    #
  })
  
  # ASSOCIATED WITH THE START TIME VALUE IN THE USER INTERFACE
  observeEvent(input$start_time, {
    #
  })
  
  # ASSOCIATED WITH THE END TIME VALUE IN THE USER INTERFACE
  observeEvent(input$end_time, {
    #
  })
  
  # RUN THE MODEL - UPDATE THE MAP AND LIST TO SHOW RESULTS
  observeEvent(input$run_model, {
    #
  })
  
  # RESET ALL FORM INPUT AND OUTPUT ELEMENTS TO DEFAULTS
  observeEvent(input$reset_input, {
    updateSliderInput(session, inputId = "budget" ,
                label="What is your budget?:",
                value = 40, min=0, max=200)
    updateSelectInput(session, "interests", "Choose the areas that you are 
                      interested in:",
                choices=list(`Interests` = list(
                  "Art",
                  "History",
                  "Adventure",
                  "Scenic",
                  "Sports",
                  "Foodie",
                  "Music",
                  "Shopping",
                  "Festivals",
                  "Eco Tourism",
                  "Architecture",
                  "Theatre",
                  "Landmark",
                  "Recreational")), selected = NULL)
    updateSelectInput(session, "locations", "Choose Specific Locations:", 
                choices=refined_locations[,1], selected = NULL)
    updateNumericInput(session, "start_time", label="Start Time (24 Hour)", 
                       value=1200)
    updateNumericInput(session, "end_time", label="End Time (24 Hour)", 
                       value=2100)
    
    # RESET THE LEAFLET MAP
    output$mymap <- renderLeaflet({
      leaflet() %>%
        addTiles() %>%
        setView(-122.6792634, 45.51867737, zoom = 14) %>%
        addMarkers(lng = refined_locations[,9], 
                   lat = refined_locations[,8], 
                   label = as.character(refined_locations[,1]), 
                   popup = as.character(refined_locations[,4]))
    })
    
    # RESET THE DATA TABLE
    output$data <- renderDataTable({
      refined_locations
    })
    
  })
  
  # OUTPUT CONTENTS OF LEAFLET MAP TO THE "mymap" AREA OF THE USER INTERFACE
  output$mymap <- renderLeaflet({
    leaflet() %>%
    addTiles() %>%
    setView(-122.6792634, 45.51867737, zoom = 14) %>%
    addMarkers(lng = refined_locations[,9], 
               lat = refined_locations[,8], 
               label = as.character(refined_locations[,1]), 
               popup = as.character(refined_locations[,4]))
  })

  # OUTPUT THE CONTENTS OF THE refined_locations MATRIX IN A TABLE
  # DEFINED AS "data" IN THE USER INTERFACE
  output$data <- renderDataTable({
    refined_locations
  })


  
  # A PLOT OF FIXED SIZE - TEMP AREA - INTO "optimal_path" AREA IN THE UI
  output$optimal_path <- renderImage({
    # A temp file to save the output. It will be deleted after renderImage
    # sends it, because deleteFile=TRUE.
    outfile <- tempfile(fileext='.png')
    
    # Generate a png
    png(outfile, width=400, height=400)
    
    # TEMP - PRINT SIMPLE HISTOGRAM
    hist(rnorm(input$n))
    dev.off()
    
    # Return a list
    list(src = outfile,
         alt = "This is alternate text")
  }, deleteFile = TRUE)
  
} # END SERVER


# INIT THE SHINY APPLICATION
shinyApp(ui, server)

